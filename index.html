<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Equipment checklist for band roadies">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Roady">
    <title>Roady - Equipment Checklist</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    <script src="https://unpkg.com/nostr-tools@2.5.2/lib/nostr.bundle.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="js/db.js"></script>
    <script src="js/app.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/js/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <div x-data="roady" x-cloak>
        <nav class="container-fluid">
            <ul>
                <li><strong>Roady</strong></li>
            </ul>
            <ul>
                <li><a href="#" @click.prevent="currentView = 'gigs'" :class="{ active: currentView === 'gigs' }">My Gigs</a></li>
                <li><a href="#" @click.prevent="currentView = 'settings'" :class="{ active: currentView === 'settings' }">Settings</a></li>
                <li x-show="options.couchDbUrl" style="opacity: 0.7; font-size: 0.85em;" x-text="getSyncStatusText()"></li>
            </ul>
        </nav>

        <main class="container">
            <!-- Gigs View (Primary) -->
            <div x-show="currentView === 'gigs'">
                <hgroup>
                    <h2>My Gigs</h2>
                    <p>Schedule and manage your gigs</p>
                </hgroup>
                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">
                    <button @click="showAddGig = true">+ Create Gig</button>
                    <button @click="showPastGigs = !showPastGigs" class="secondary outline" x-text="showPastGigs ? 'Hide Past Gigs' : 'Show Past Gigs'"></button>
                </div>

                <dialog :open="showAddGig || editingGig">
                    <article>
                        <header>
                            <a href="#" @click.prevent="cancelGigEdit()" aria-label="Close" class="close"></a>
                            <h3 x-text="editingGig ? 'Edit Gig' : 'Create Gig'"></h3>
                        </header>
                        <input type="text" x-model="newGig.name" placeholder="Venue or gig name (e.g., 'Blue Note Jazz Club')" />
                        <input type="date" x-model="newGig.date" />
                        <select x-model="newGig.gigTypeId" :disabled="editingGig && isGigInPast(editingGig)">
                            <option value="">Select template...</option>
                            <template x-for="type in gigTypes" :key="type._id">
                                <option :value="type._id" x-text="type.name"></option>
                            </template>
                        </select>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <label>
                                Arrival Time (optional)
                                <input type="time" x-model="newGig.arrivalTime" value="18:00" />
                                <small class="text-muted">When crew should arrive</small>
                            </label>
                            <label>
                                Doors Open (optional)
                                <input type="time" x-model="newGig.doorsOpenTime" value="19:00" />
                                <small class="text-muted">When doors open to public</small>
                            </label>
                        </div>
                        <label>
                            Map Link (optional)
                            <input type="url" x-model="newGig.mapLink" placeholder="https://maps.google.com/..." />
                        </label>
                        <p x-show="editingGig && isGigInPast(editingGig)" class="text-muted" style="font-size: 0.9rem;">
                            Note: Changing template for past gigs is not supported.
                        </p>
                        <p x-show="editingGig && !isGigInPast(editingGig) && gigHasChecklistProgress(editingGig)" class="text-muted" style="font-size: 0.9rem; color: var(--pico-del-color, #c62828);">
                            ‚ö† Warning: Changing template will reset your checklist progress.
                        </p>
                        <footer style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <button x-show="editingGig" @click="confirmDeleteGig()" class="secondary outline" style="background: var(--pico-del-color, #c0392b); color: white;">Delete Gig</button>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button @click="saveGig()" x-text="editingGig ? 'Save' : 'Create'"></button>
                                <button @click="cancelGigEdit()" class="secondary">Cancel</button>
                            </div>
                        </footer>
                    </article>
                </dialog>

                <div class="gig-list">
                    <template x-for="gig in getFilteredGigs()" :key="gig._id">
                        <article class="gig-item" :class="{ 'past-gig': isGigInPast(gig) }">
                            <div style="flex: 1;">
                                <strong x-text="gig.name || 'Unnamed Gig'"></strong>
                                <p class="text-muted">
                                    <span x-text="formatDate(gig.date)"></span> ‚Ä¢ <span x-text="getGigTypeName(gig.gigTypeId)"></span>
                                </p>
                                <p x-show="gig.arrivalTime || gig.doorsOpenTime" class="text-muted" style="font-size: 0.85rem; margin-top: 0.25rem;">
                                    <span x-show="gig.arrivalTime">‚è∞ <span x-text="gig.arrivalTime"></span></span>
                                    <span x-show="gig.arrivalTime && gig.doorsOpenTime"> ‚Ä¢ </span>
                                    <span x-show="gig.doorsOpenTime">üö™ <span x-text="gig.doorsOpenTime"></span></span>
                                </p>
                                <small class="progress">
                                    To Gig: <span x-text="getChecklistProgress(gig.loadoutChecklist)"></span> |
                                    From Gig: <span x-text="getChecklistProgress(gig.loadinChecklist)"></span>
                                </small>
                            </div>
                            <div class="button-group">
                                <button @click="viewGigDetail(gig._id, 'leavingForGig')" class="contrast">To Gig</button>
                                <button @click="viewGigDetail(gig._id, 'leavingFromGig')">From Gig</button>
                                <button @click="editGig(gig)" class="secondary outline">Edit</button>
                            </div>
                        </article>
                    </template>
                    <p x-show="getFilteredGigs().length === 0 && !showPastGigs" class="empty-state">No upcoming gigs. Create your first gig!</p>
                    <p x-show="getFilteredGigs().length === 0 && showPastGigs" class="empty-state">No gigs found.</p>
                </div>

                <!-- Leaving for Gig (Load-out) -->
                <dialog :open="selectedGigId && gigChecklistMode === 'leavingForGig'">
                    <article>
                        <header>
                            <a href="#" @click.prevent="closeGigDetail()" aria-label="Close" class="close"></a>
                            <h3 x-text="selectedGig ? (selectedGig.name || 'Unnamed Gig') : ''"></h3>
                            <p class="text-muted" x-text="selectedGig ? formatDate(selectedGig.date) + ' ‚Ä¢ ' + getGigTypeName(selectedGig.gigTypeId) : ''"></p>
                            <div x-show="selectedGig && (selectedGig.arrivalTime || selectedGig.doorsOpenTime)" style="margin-top: 0.5rem;">
                                <p x-show="selectedGig && selectedGig.arrivalTime" class="text-muted" style="margin: 0;">
                                    ‚è∞ Arrival: <span x-text="selectedGig.arrivalTime"></span>
                                </p>
                                <p x-show="selectedGig && selectedGig.doorsOpenTime" class="text-muted" style="margin: 0;">
                                    üö™ Doors: <span x-text="selectedGig.doorsOpenTime"></span>
                                </p>
                            </div>
                            <p x-show="selectedGig && selectedGig.mapLink" style="margin-top: 0.5rem;">
                                <a :href="selectedGig.mapLink" target="_blank" rel="noopener">üìç Open Map</a>
                            </p>
                        </header>

                        <hgroup>
                            <h4>Leaving for Gig</h4>
                            <p>Load items into vehicle before departing</p>
                        </hgroup>

                        <template x-if="selectedGig">
                            <div>
                                <!-- Progress bar -->
                                <div class="checklist-progress">
                                    <div class="progress-text">
                                        <span x-text="getChecklistProgress(selectedGig.loadoutChecklist)"></span> loaded
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill"
                                             :style="`width: ${(selectedGig.loadoutChecklist.filter(i => i.checked).length / selectedGig.loadoutChecklist.length * 100).toFixed(0)}%`"></div>
                                    </div>
                                </div>

                                <!-- Missing items section (prominent) -->
                                <div class="checklist-section-missing">
                                    <template x-for="(item, index) in selectedGig.loadoutChecklist" :key="index">
                                        <div x-show="!item.checked">
                                            <div class="checklist-item-missing" @click="toggleChecklistItem('loadout', index)">
                                                <div class="item-icon">‚¨ú</div>
                                                <div class="item-content">
                                                    <div class="item-name" x-text="getEquipmentName(item.equipmentId, item.itemNumber)"></div>
                                                    <div class="item-action">Tap to mark as loaded</div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Loaded items section (collapsible) -->
                                <div class="checklist-section-loaded">
                                    <h5 class="section-heading-loaded" @click="showLoadedItems = !showLoadedItems" style="cursor: pointer;">
                                        ‚úì LOADED
                                        <span x-text="showLoadedItems ? '‚ñº' : '‚ñ∂'"></span>
                                    </h5>
                                    <div x-show="showLoadedItems" class="checklist">
                                        <template x-for="(item, index) in selectedGig.loadoutChecklist" :key="index">
                                            <div x-show="item.checked">
                                                <div class="checklist-item-loaded" @click="toggleChecklistItem('loadout', index)">
                                                    <div class="item-icon">‚úì</div>
                                                    <div class="item-name" x-text="getEquipmentName(item.equipmentId, item.itemNumber)"></div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div class="add-item-section">
                            <button @click="showAddItemToGig = true" class="secondary outline" style="width: 100%;">+ Add Item to This Gig</button>
                        </div>

                        <!-- Add item to gig modal -->
                        <div x-show="showAddItemToGig" class="inline-modal">
                            <div class="inline-modal-content">
                                <h5>Add Item</h5>
                                <select x-model="newItemForGig.equipmentId">
                                    <option value="">Select from equipment catalog...</option>
                                    <template x-for="item in getAvailableEquipment()" :key="item._id">
                                        <option :value="item._id" x-text="item.name"></option>
                                    </template>
                                </select>
                                <p style="text-align: center; margin: 0.5rem 0;">- OR -</p>
                                <input type="text" x-model="newItemForGig.newEquipmentName" placeholder="Or type new item name to create it..." />
                                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                    <button @click="addItemToGig()">Add</button>
                                    <button @click="cancelAddItemToGig()" class="secondary">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <!-- Confirmation modal for adding to template -->
                        <div x-show="showAddToGigTypeConfirm" class="inline-modal">
                            <div class="inline-modal-content">
                                <h5>Add to Template?</h5>
                                <p x-text="`Do you want to add &quot;${newItemForGig.addedEquipmentName || ''}&quot; to the &quot;${selectedGig ? getGigTypeName(selectedGig.gigTypeId) : ''}&quot; template for all future gigs?`"></p>
                                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                    <button @click="confirmAddToGigType(true)">Yes, Add to Template</button>
                                    <button @click="confirmAddToGigType(false)" class="secondary">No, Only This Gig</button>
                                </div>
                            </div>
                        </div>

                        <footer>
                            <button @click="closeGigDetail()">Close</button>
                        </footer>
                    </article>
                </dialog>

                <!-- Leaving from Gig (Load-in) -->
                <dialog :open="selectedGigId && gigChecklistMode === 'leavingFromGig'">
                    <article>
                        <header>
                            <a href="#" @click.prevent="closeGigDetail()" aria-label="Close" class="close"></a>
                            <h3 x-text="selectedGig ? (selectedGig.name || 'Unnamed Gig') : ''"></h3>
                            <p class="text-muted" x-text="selectedGig ? formatDate(selectedGig.date) + ' ‚Ä¢ ' + getGigTypeName(selectedGig.gigTypeId) : ''"></p>
                            <div x-show="selectedGig && (selectedGig.arrivalTime || selectedGig.doorsOpenTime)" style="margin-top: 0.5rem;">
                                <p x-show="selectedGig && selectedGig.arrivalTime" class="text-muted" style="margin: 0;">
                                    ‚è∞ Arrival: <span x-text="selectedGig.arrivalTime"></span>
                                </p>
                                <p x-show="selectedGig && selectedGig.doorsOpenTime" class="text-muted" style="margin: 0;">
                                    üö™ Doors: <span x-text="selectedGig.doorsOpenTime"></span>
                                </p>
                            </div>
                            <p x-show="selectedGig && selectedGig.mapLink" style="margin-top: 0.5rem;">
                                <a :href="selectedGig.mapLink" target="_blank" rel="noopener">üìç Open Map</a>
                            </p>
                        </header>

                        <hgroup>
                            <h4>Leaving from Gig</h4>
                            <p>Pack items back into vehicle after the show</p>
                        </hgroup>

                        <template x-if="selectedGig">
                            <div>
                                <!-- Progress bar -->
                                <div class="checklist-progress">
                                    <div class="progress-text">
                                        <span x-text="getChecklistProgress(selectedGig.loadinChecklist)"></span> packed
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill"
                                             :style="`width: ${(selectedGig.loadinChecklist.filter(i => i.checked).length / selectedGig.loadinChecklist.length * 100).toFixed(0)}%`"></div>
                                    </div>
                                </div>

                                <!-- Missing items section (what you still need to find and pack) -->
                                <div class="checklist-section-missing">
                                    <template x-for="(item, index) in selectedGig.loadinChecklist" :key="index">
                                        <div x-show="!item.checked">
                                            <div class="checklist-item-missing" @click="toggleLoadinItem(index)">
                                                <div class="item-icon">‚¨ú</div>
                                                <div class="item-content">
                                                    <div class="item-name" x-text="getEquipmentName(item.equipmentId, item.itemNumber)"></div>
                                                    <div class="item-action">Tap to mark as packed</div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Packed items section (collapsible) -->
                                <div class="checklist-section-loaded">
                                    <h5 class="section-heading-loaded" @click="showPackedItems = !showPackedItems" style="cursor: pointer;">
                                        ‚úì PACKED
                                        <span x-text="showPackedItems ? '‚ñº' : '‚ñ∂'"></span>
                                    </h5>
                                    <div x-show="showPackedItems" class="checklist">
                                        <template x-for="(item, index) in selectedGig.loadinChecklist" :key="index">
                                            <div x-show="item.checked">
                                                <div class="checklist-item-loaded" @click="toggleLoadinItem(index)">
                                                    <div class="item-icon">‚úì</div>
                                                    <div class="item-name" x-text="getEquipmentName(item.equipmentId, item.itemNumber)"></div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <footer>
                            <button @click="closeGigDetail()">Close</button>
                        </footer>
                    </article>
                </dialog>
            </div>

            <!-- Settings View (Admin/Setup) -->
            <div x-show="currentView === 'settings'" x-data="{ settingsTab: 'equipment' }">
                <hgroup>
                    <h2>Settings</h2>
                    <p>Manage your equipment catalog and templates</p>
                </hgroup>

                <div role="group" class="tab-buttons">
                    <button @click="settingsTab = 'equipment'" :class="settingsTab === 'equipment' ? '' : 'outline'">
                        Equipment Catalog
                    </button>
                    <button @click="settingsTab = 'templates'" :class="settingsTab === 'templates' ? '' : 'outline'">
                        Templates
                    </button>
                    <button @click="settingsTab = 'options'" :class="settingsTab === 'options' ? '' : 'outline'">
                        Options
                    </button>
                </div>

                <!-- Equipment Section -->
                <section x-show="settingsTab === 'equipment'">
                    <div class="settings-section-header">
                        <h3>Equipment Catalog</h3>
                        <button @click="showAddEquipment = true">+ Add Item</button>
                    </div>

                <dialog :open="showAddEquipment || editingEquipment">
                    <article>
                        <header>
                            <a href="#" @click.prevent="cancelEquipmentEdit()" aria-label="Close" class="close"></a>
                            <h3 x-text="editingEquipment ? 'Edit Equipment Item' : 'Add Equipment Item'"></h3>
                        </header>
                        <input type="text" x-model="newEquipment.name" placeholder="Item name (e.g., 'Shure SM58 Mic')" />
                        <textarea x-model="newEquipment.description" placeholder="Description or notes (optional)"></textarea>
                        <footer style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <button x-show="editingEquipment" @click="deleteEquipment(editingEquipment._id); cancelEquipmentEdit()" class="secondary outline" style="background: var(--pico-del-color, #c0392b); color: white;">Delete Item</button>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button @click="saveEquipment()">Save</button>
                                <button @click="cancelEquipmentEdit()" class="secondary">Cancel</button>
                            </div>
                        </footer>
                    </article>
                </dialog>

                <div class="equipment-list">
                    <template x-for="item in equipment" :key="item._id">
                        <article class="equipment-item">
                            <div>
                                <strong x-text="item.name"></strong>
                                <p x-text="item.description" class="text-muted"></p>
                            </div>
                            <button @click="editEquipment(item)" class="contrast">Edit</button>
                        </article>
                    </template>
                    <p x-show="equipment.length === 0" class="empty-state">No equipment yet. Add your first item!</p>
                </div>
                </section>

                <!-- Templates Section -->
                <section x-show="settingsTab === 'templates'">
                    <div class="settings-section-header">
                        <h3>Templates</h3>
                        <button @click="showAddGigType = true">+ Add Template</button>
                    </div>

                <dialog :open="showAddGigType || editingGigType">
                    <article>
                        <header>
                            <a href="#" @click.prevent="cancelGigTypeEdit()" aria-label="Close" class="close"></a>
                            <h3 x-text="editingGigType ? 'Edit Template' : 'Add Template'"></h3>
                        </header>
                        <input type="text" x-model="newGigType.name" placeholder="Template name (e.g., 'Small Venue', 'Festival')" />
                        <fieldset class="equipment-selector">
                            <legend>Select Equipment for This Template</legend>
                            <template x-for="item in equipment" :key="item._id">
                                <div class="equipment-quantity-row">
                                    <label style="flex: 1; margin: 0;">
                                        <input type="checkbox"
                                               :checked="newGigType.equipment.some(e => e.equipmentId === item._id)"
                                               @change="toggleEquipmentInTemplate(item._id)" />
                                        <span x-text="item.name"></span>
                                    </label>
                                    <div x-show="newGigType.equipment.some(e => e.equipmentId === item._id)" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <label style="margin: 0; font-size: 0.9rem;">Qty:</label>
                                        <input type="number"
                                               min="1"
                                               max="99"
                                               style="width: 60px; padding: 0.25rem 0.5rem;"
                                               :value="(newGigType.equipment.find(e => e.equipmentId === item._id) || {}).quantity || 1"
                                               @input="updateEquipmentQuantity(item._id, $event.target.value)" />
                                    </div>
                                </div>
                            </template>
                        </fieldset>
                        <footer>
                            <button @click="saveGigType">Save</button>
                            <button @click="cancelGigTypeEdit()" class="secondary">Cancel</button>
                        </footer>
                    </article>
                </dialog>

                <div class="gigtype-list">
                    <template x-for="type in gigTypes" :key="type._id">
                        <article class="gigtype-item">
                            <div>
                                <strong x-text="type.name"></strong>
                                <p x-text="getEquipmentCount(type) + ' items'" class="text-muted"></p>
                            </div>
                            <div class="button-group">
                                <button @click="editGigType(type)" class="contrast">Edit</button>
                                <button @click="deleteGigType(type._id)" class="secondary outline">Delete</button>
                            </div>
                        </article>
                    </template>
                    <p x-show="gigTypes.length === 0" class="empty-state">No templates yet. Create your first template!</p>
                </div>
                </section>

                <!-- Options Section -->
                <section x-show="settingsTab === 'options'">
                    <h3>Application Options</h3>

                    <div style="margin-top: 2rem;">
                        <h4>Sync Settings</h4>
                        <label>
                            CouchDB URL
                            <input type="url"
                                   x-model="options.couchDbUrl"
                                   @change="saveOptions()"
                                   placeholder="https://username:password@your-couchdb-server.com" />
                            <small class="text-muted">
                                Optional: URL for CouchDB server with embedded credentials for data synchronization.
                                Format: <code>https://username:password@server.com</code><br>
                                Leave empty to use local storage only.
                            </small>
                        </label>

                        <div x-show="options.couchDbUrl" style="margin-top: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--pico-form-element-background-color); border-radius: var(--pico-border-radius);">
                                <div style="flex: 1;">
                                    <strong>Sync Status:</strong> <span x-text="getSyncStatusText()"></span>
                                </div>
                                <button @click="disableSync()" class="secondary outline" style="margin: 0;">Disconnect</button>
                            </div>

                            <div x-show="syncError" style="margin-top: 1rem; padding: 1rem; background: var(--pico-del-background-color, #ffebee); color: var(--pico-del-color, #c62828); border-radius: var(--pico-border-radius);">
                                <strong>‚ö† Error:</strong> <span x-text="syncError"></span>
                            </div>

                            <p class="text-muted" style="margin-top: 1rem; font-size: 0.9rem;">
                                <strong>Note:</strong> Sync is bidirectional and continuous. Changes made on this device will sync to the server, and changes from other devices will sync here automatically.
                            </p>
                            <details style="margin-top: 1rem;">
                                <summary style="cursor: pointer; font-weight: bold;">Setup Instructions for CouchDB</summary>
                                <ol style="margin-top: 0.5rem; font-size: 0.9rem;">
                                    <li>Create a database named <code>roady</code> on your CouchDB server</li>
                                    <li>Enable CORS on your CouchDB server to allow your domain</li>
                                    <li>Include credentials in the URL: <code>https://username:password@your-server.com</code></li>
                                    <li>Save the URL in the field above to start syncing</li>
                                </ol>
                            </details>
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <h4>Data Management</h4>
                        <p class="text-muted">Data export/import features coming soon.</p>
                    </div>
                </section>
            </div>
        </main>
    </div>
</body>
</html>
