Extended Product Requirements Document (PRD) – Low-Volume Multi-App CouchDB with R2 Backup, PWA Authentication, and Per-Database Access Control

Objective:
Provide a lightweight, low-cost backend for multiple small web applications using a single CouchDB instance on a VPS, with offsite durable backups to Cloudflare R2. The system must support per-app logical separation of data, secure authentication for PWAs, fine-grained per-database access control, simple recovery in case of VPS failure, and minimal operational overhead.

Architecture Overview:
A single VPS hosts CouchDB. Each application is allocated its own database within the CouchDB instance, allowing logical separation without the overhead of multiple database servers. CouchDB handles local storage of data files and views on the VPS filesystem. For low-volume apps, a small VPS with modest CPU and RAM is sufficient. Attachments should be minimized or externalized to prevent local storage growth and reduce backup size.

PWA Authentication and Access Control Workflow:
Each client application is provisioned with a unique CouchDB user and password. The PWA logs in by sending a POST request to CouchDB’s /_session endpoint with these credentials. CouchDB responds with a session token (AuthSession cookie) that is used for subsequent requests. PouchDB can be configured to include this cookie in all fetch requests.

Access is restricted per database:

Each database has a _security document specifying members and roles.

The user associated with the PWA is assigned either directly in members or via a specific role corresponding to the database.

This ensures the user can only read/write to their assigned database.

The session expires after a configurable duration (max_age), and the PWA must re-authenticate to obtain a new session.
Optionally, a lightweight backend API can be introduced to mediate authentication, issue JWTs, and handle session renewal.

Backup and Recovery:
Durable offsite storage is provided via Cloudflare R2. Daily or periodic backups are generated by exporting each database as JSON (including attachments if needed) using CouchDB’s _all_docs?include_docs=true endpoint or couchbackup. These backups are uploaded to R2, taking advantage of its free-tier storage and zero egress costs. In the event of VPS failure, databases can be restored by importing the JSON dumps back into CouchDB. This approach ensures that data loss is mitigated while avoiding the cost of running a live secondary CouchDB node.

Operational Considerations:

Local CouchDB storage must remain sufficient for normal operations; VPS disk quotas should be monitored.

Indexing and view performance should be managed per database to avoid slow queries.

Backup scripts should be automated via cron or similar scheduler.

Attachments should be externalized or capped to maintain low storage usage.

Session expiration and renewal must be handled by the PWA or optional backend API.

User management in CouchDB must be coordinated with provisioning for each new client application.

Each user is restricted to a single database to enforce per-app isolation; roles and _security documents must be configured accordingly.

This design provides a cost-effective, low-maintenance solution for hosting multiple small applications with secure client authentication, fine-grained per-database access control, and reliable offsite backup, leveraging a single VPS and Cloudflare R2.